service: auth-api
app: api-node
org: ricardoonodera

custom:
   CORS_ORIGIN:
      staging: https://bid-admin-staging.web.app
      production: https://bid-admin.web.app
   AUTH0:
      staging:
         AUDIENCE: https://bid-next-ui.now.sh
         DOMAIN: staging-next-ui.auth0.com
         ISSUER: https://staging-next-ui.auth0.com/
   REGION: ${opt:region, 'sa-east-1'}
   STAGE: ${opt:stage, self:provider.stage}
   SERVICE_NAME: auth-api
   webpack:
      webpackConfig: ./webpack.config.js
      includeModules: true

plugins:
   - serverless-webpack

provider:
   name: aws
   runtime: nodejs12.x
   region: ${self:custom.REGION}
   iamRoleStatements:
      - Effect: Allow
        Action:
           - ssm:GetParameter
           - ssm:GetParameters
           - ssm:GetParametersByPath
           - ssm:DescribeParameters
        Resource: "*"

functions:
   auth-api:
      handler: src/handler.api
      environment:
         CORS_ORIGIN: ${self:custom.CORS_ORIGIN.${opt:stage, self:provider.stage}}
         STAGE: ${self:custom.STAGE}
         SERVICE_NAME: ${self:custom.SERVICE_NAME}
         REGION: ${self:custom.REGION}
         AUTH0_AUDIENCE: ${self:custom.AUTH0.${opt:stage, self:provider.stage}.AUDIENCE}
         AUTH0_DOMAIN: ${self:custom.AUTH0.${opt:stage, self:provider.stage}.DOMAIN}
         AUTH0_ISSUER: ${self:custom.AUTH0.${opt:stage, self:provider.stage}.ISSUER}

      events:
         - http:
              path: /
              method: ANY
              cors: true
         - http:
              path: /{any+}
              method: ANY
              cors: true
